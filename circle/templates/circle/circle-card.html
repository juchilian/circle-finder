{% block customCss %}
    
{% endblock %}
<div class="card mb-3" style="max-width: 540px">
    <div class="row no-gutters">
        <div class="col-md-4 my-auto">
            <img class="card-img" src="{{ circle.image.url }}">
        </div>
        <div class="col-md-8">
            <div class="card-body">
                <form action="{% url 'circle:like-circle-view' %}" method="POST" class="like-form" id='{{circle.id}}'>
                    {% csrf_token %}
                    <input type="hidden" name='circle_id' value="{{circle.id}}">
                    {% if request.user not in circle.liked.all %}
                        <button type="submit" class="btn btn-light border like-btn{{circle.id}}">
                            Like
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary like-btn{{circle.id}}">
                            Unlike
                        </button>
                        
                    {% endif %}
                </form>
                <h5 class="card-title"><a href="{% url 'circle:detail-circle-view' slug=circle.slug %}">{{ circle.name }}</a></h5>
                <p>{{ circle.description }}</p>
                <p><a href="{{circle.twitter_url}}" target="_blank">Twitter</a></p>
                <p><a href="{{circle.insta_url}}" target="_blank">Instagram</a></p>
            </div>
        </div>
    </div>
</div>
{% if request.user == circle.owner %}
<div><a href="/circle/{{circle.slug}}/edit">編集する</a></div>

{% endif %}
{% block myJs %}
<script>
    $(document).ready(function() {
        $('.like-form').submit(function(e) {
            e.preventDefault()
            {% if request.user.is_authenticated %}
            // user is logged in
            const circle_id = $(this).attr('id')
            const likeBtn = $(`.like-btn${circle_id}`)
            const likeText = likeBtn.text()
            const trim = $.trim(likeText)

            // const url = '{% url 'circle:like-circle-view' %}'
            const url = $(this).attr('action')
            // let res;
            // const likes = $(`.like-count${circle_id}`).text()
            // const trimCount = parseInt(likes)
            // console.log(trimCount + 1);
            $.ajax({
                type:'POST',
                url: url,
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    'circle_id':circle_id,
                },
                success: function(response) {
                    if(trim === 'Unlike') {
                        $(`.like-btn${circle_id}`).text('Like')
                        $(likeBtn).removeClass("btn-primary")
                        $(likeBtn).addClass("btn-light")
                    } else {
                        $(`.like-btn${circle_id}`).text('Unlike')
                        $(likeBtn).removeClass("btn-light")
                        $(likeBtn).addClass("btn-primary")
                    }
                },
                error: function(response) {
                    console.log('error', response);
                }
            })
            {% else %}
            // not logged in
                if(window.confirm('この機能を使うにはログインが必要です。\nログインしますか？')){
                    next_url = location.pathname
                    redirect_url = "{% url 'account_login' %}" + "?next=" + next_url
                    window.location = redirect_url
                }
            {% endif %}
        })
    })

</script>
{% endblock myJs %}